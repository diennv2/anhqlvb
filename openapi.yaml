openapi: 3.0.3
info:
  title: Hải Phòng Task Management System API
  version: "1.0.0"
  description: |
    REST API đầy đủ cho hệ thống quản lý công việc Hải Phòng
    - 79 endpoints covering: Auth, Users, Roles, Departments, Tasks, Workflow, Notifications, Logs, Reports
    - JWT Authentication
    - Pagination, Filtering, Sorting
    - Request/Response examples

servers:
  - url: https://api.example.com/api/v1
    description: Production server

tags:
  - name: Auth
    description: Authentication & Authorization
  - name: Users
    description: User Management
  - name: Roles
    description: Role Management
  - name: Permissions
    description: Permission Management
  - name: Departments
    description: Department Management
  - name: Positions
    description: Position Management
  - name: TaskCategories
    description: Task Category Management
  - name: TaskPriorities
    description: Task Priority Management
  - name: TaskStatuses
    description: Task Status Management
  - name: Tasks
    description: Task Management
  - name: TaskAssignees
    description: Task Assignment
  - name: Workflows
    description: Workflow Management
  - name: Notifications
    description: Notification Management
  - name: Logs
    description: Logging & History
  - name: Reports
    description: Reporting & Analytics

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        error: { type: string, example: "validation_error" }
        message: { type: string, example: "Field is required" }
        field: { type: string, example: "title" }

    MetaPaging:
      type: object
      properties:
        page: { type: integer, example: 1 }
        pageSize: { type: integer, example: 20 }
        total: { type: integer, example: 150 }

    User:
      type: object
      properties:
        id: { type: integer, example: 1 }
        username: { type: string, example: "nguyenvana" }
        email: { type: string, example: "nguyenvana@haiphong.gov.vn" }
        full_name: { type: string, example: "Nguyễn Văn A" }
        phone: { type: string, example: "0912345678" }
        department: { type: string, example: "Phòng Hành chính" }
        position: { type: string, example: "Trưởng phòng" }
        role: { type: string, example: "Manager" }
        status: { type: string, example: "active" }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    Role:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "Admin" }
        description: { type: string, example: "Administrator role" }

    Permission:
      type: object
      properties:
        id: { type: integer, example: 1 }
        code: { type: string, example: "task.create" }
        description: { type: string, example: "Create task" }

    Department:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "Phòng Hành chính" }
        code: { type: string, example: "HC" }
        parent_id: { type: integer, nullable: true, example: null }
        description: { type: string, example: "Phòng Hành chính" }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    Position:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "Trưởng phòng" }
        level: { type: integer, example: 5 }

    TaskCategory:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "Văn bản đi" }
        description: { type: string, example: "Loại công việc văn bản đi" }
        is_active: { type: boolean, example: true }

    TaskPriority:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "Cao" }
        level: { type: integer, example: 1 }
        is_default: { type: boolean, example: false }

    TaskStatus:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "Đang xử lý" }
        code: { type: string, example: "processing" }
        is_closed_state: { type: boolean, example: false }

    Task:
      type: object
      properties:
        id: { type: integer, example: 123 }
        title: { type: string, example: "Báo cáo tài chính Q1" }
        description: { type: string, example: "Cần hoàn thành báo cáo..." }
        category_id: { type: integer, example: 2 }
        priority_id: { type: integer, example: 1 }
        status_id: { type: integer, example: 2 }
        creator_id: { type: integer, example: 5 }
        department_id: { type: integer, example: 3 }
        parent_task_id: { type: integer, nullable: true }
        start_date: { type: string, format: date, example: "2026-02-10" }
        due_date: { type: string, format: date, example: "2026-03-10" }
        completed_date: { type: string, format: date, nullable: true }
        progress: { type: integer, example: 50 }
        confidential: { type: boolean, example: false }
        must_confirm: { type: boolean, example: true }
        workflow_id: { type: integer, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    TaskFile:
      type: object
      properties:
        id: { type: integer, example: 1 }
        task_id: { type: integer, example: 123 }
        file_name: { type: string, example: "BaoCao_Q1.xlsx" }
        file_path: { type: string, example: "/files/2026/02/BaoCao_Q1.xlsx" }
        file_type: { type: string, example: "xlsx" }
        file_size: { type: integer, example: 1024000 }
        uploaded_by: { type: integer, example: 5 }
        uploaded_at: { type: string, format: date-time }

    TaskLog:
      type: object
      properties:
        id: { type: integer, example: 1 }
        task_id: { type: integer, example: 123 }
        user_id: { type: integer, example: 5 }
        action: { type: string, example: "status_change" }
        content: { type: string, example: "Chuyển trạng thái từ 'Mới' sang 'Đang xử lý'" }
        is_system: { type: boolean, example: true }
        created_at: { type: string, format: date-time }

    Workflow:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "Quy trình phê duyệt văn bản" }
        description: { type: string, example: "Quy trình 3 bước" }
        is_active: { type: boolean, example: true }

    WorkflowStep:
      type: object
      properties:
        id: { type: integer, example: 1 }
        workflow_id: { type: integer, example: 1 }
        name: { type: string, example: "Trưởng phòng duyệt" }
        order_index: { type: integer, example: 1 }
        is_approval: { type: boolean, example: true }
        auto_advance: { type: boolean, example: false }
        role_id: { type: integer, nullable: true }

    Notification:
      type: object
      properties:
        id: { type: integer, example: 1 }
        user_id: { type: integer, example: 5 }
        content: { type: string, example: "Task #123 hết hạn hôm nay" }
        type: { type: string, example: "task" }
        read_status: { type: boolean, example: false }
        task_id: { type: integer, nullable: true, example: 123 }
        sent_at: { type: string, format: date-time }

paths:

  # ========== AUTH ==========
  /auth/login:
    post:
      tags: [Auth]
      summary: Đăng nhập
      description: Đăng nhập với username/password, trả về JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username: { type: string }
                password: { type: string }
            example:
              username: "nguyenvana"
              password: "123456"
      responses:
        '200':
          description: Đăng nhập thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token: { type: string }
                  refresh_token: { type: string }
                  token_type: { type: string }
              example:
                access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                token_type: "Bearer"
        '401':
          description: Sai thông tin đăng nhập
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
              example:
                error: "unauthorized"
                message: "Invalid credentials"

  /auth/token/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token: { type: string }
            example:
              refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Token mới
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token: { type: string }
                  refresh_token: { type: string }

  /auth/request-reset:
    post:
      tags: [Auth]
      summary: Yêu cầu reset mật khẩu
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
            example:
              email: "nguyenvana@haiphong.gov.vn"
      responses:
        '200':
          description: Email đã gửi

  /auth/reset-password:
    post:
      tags: [Auth]
      summary: Đặt lại mật khẩu
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                token: { type: string }
                new_password: { type: string }
            example:
              token: "abc123"
              new_password: "newpass123"
      responses:
        '200':
          description: Đổi mật khẩu thành công

  /auth/whoami:
    get:
      tags: [Auth]
      summary: Lấy thông tin user hiện tại
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Thông tin user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }

  # ========== USERS ==========
  /users:
    get:
      tags: [Users]
      summary: Danh sách user
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20 }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: department
          schema: { type: integer }
        - in: query
          name: role
          schema: { type: integer }
      responses:
        '200':
          description: Danh sách user
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/User' }
                  meta: { $ref: '#/components/schemas/MetaPaging' }
              example:
                data:
                  - id: 1
                    username: "nguyenvana"
                    full_name: "Nguyễn Văn A"
                    email: "nguyenvana@hp.gov.vn"
                    department: "Phòng HC"
                    position: "Trưởng phòng"
                    role: "Manager"
                    status: "active"
                meta:
                  page: 1
                  pageSize: 20
                  total: 150

    post:
      tags: [Users]
      summary: Tạo user mới
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/User' }
            example:
              username: "tranthib"
              email: "tranthib@hp.gov.vn"
              full_name: "Trần Thị B"
              password: "123456"
              department_id: 2
              position_id: 3
              role_id: 2
      responses:
        '201':
          description: Tạo thành công
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }

  /users/{id}:
    get:
      tags: [Users]
      summary: Chi tiết user
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }

    patch:
      tags: [Users]
      summary: Cập nhật user
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/User' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [Users]
      summary: Xóa user
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  /users/{id}/password:
    put:
      tags: [Users]
      summary: Đổi mật khẩu user
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                new_password: { type: string }
            example:
              new_password: "newpass123"
      responses:
        '200':
          description: Đổi mật khẩu thành công

  /users/{id}/logs:
    get:
      tags: [Users]
      summary: Lịch sử thao tác user
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Danh sách logs
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TaskLog' }
                  # ========== ROLES ==========
  /roles:
    get:
      tags: [Roles]
      summary: Danh sách roles
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách roles
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Role' }
              example:
                - id: 1
                  name: "Admin"
                  description: "Administrator"
                - id: 2
                  name: "Manager"
                  description: "Quản lý"

    post:
      tags: [Roles]
      summary: Tạo role mới
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Role' }
            example:
              name: "Staff"
              description: "Nhân viên"
      responses:
        '201':
          description: Tạo thành công
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Role' }

  /roles/{id}:
    get:
      tags: [Roles]
      summary: Chi tiết role
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin role
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Role' }

    patch:
      tags: [Roles]
      summary: Cập nhật role
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Role' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [Roles]
      summary: Xóa role
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  # ========== PERMISSIONS ==========
  /permissions:
    get:
      tags: [Permissions]
      summary: Danh sách permissions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách permissions
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Permission' }
              example:
                - id: 1
                  code: "task.create"
                  description: "Tạo công việc"
                - id: 2
                  code: "task.delete"
                  description: "Xóa công việc"

  # ========== DEPARTMENTS ==========
  /departments:
    get:
      tags: [Departments]
      summary: Danh sách phòng ban
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách departments
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Department' }
              example:
                - id: 1
                  name: "Phòng Hành chính"
                  code: "HC"
                  parent_id: null
                - id: 2
                  name: "Phòng Tài chính"
                  code: "TC"
                  parent_id: null

    post:
      tags: [Departments]
      summary: Tạo phòng ban mới
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Department' }
            example:
              name: "Phòng Kế hoạch"
              code: "KH"
              parent_id: null
              description: "Phòng Kế hoạch"
      responses:
        '201':
          description: Tạo thành công

  /departments/{id}:
    get:
      tags: [Departments]
      summary: Chi tiết phòng ban
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin department
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Department' }

    patch:
      tags: [Departments]
      summary: Cập nhật phòng ban
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Department' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [Departments]
      summary: Xóa phòng ban
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  # ========== POSITIONS ==========
  /positions:
    get:
      tags: [Positions]
      summary: Danh sách chức vụ
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách positions
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Position' }
              example:
                - id: 1
                  name: "Giám đốc"
                  level: 10
                - id: 2
                  name: "Trưởng phòng"
                  level: 5

    post:
      tags: [Positions]
      summary: Tạo chức vụ mới
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Position' }
            example:
              name: "Phó phòng"
              level: 4
      responses:
        '201':
          description: Tạo thành công

  /positions/{id}:
    get:
      tags: [Positions]
      summary: Chi tiết chức vụ
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin position
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Position' }

    patch:
      tags: [Positions]
      summary: Cập nhật chức vụ
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Position' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [Positions]
      summary: Xóa chức vụ
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  # ========== TASK CATEGORIES ==========
  /task-categories:
    get:
      tags: [TaskCategories]
      summary: Danh sách loại công việc
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách categories
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TaskCategory' }
              example:
                - id: 1
                  name: "Văn bản đi"
                  description: "Loại công việc văn bản đi"
                  is_active: true

    post:
      tags: [TaskCategories]
      summary: Tạo loại công việc
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TaskCategory' }
            example:
              name: "Văn bản đến"
              description: "Loại công việc văn bản đến"
              is_active: true
      responses:
        '201':
          description: Tạo thành công

  /task-categories/{id}:
    get:
      tags: [TaskCategories]
      summary: Chi tiết loại công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin category
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TaskCategory' }

    patch:
      tags: [TaskCategories]
      summary: Cập nhật loại công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TaskCategory' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [TaskCategories]
      summary: Xóa loại công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  # ========== TASK PRIORITIES ==========
  /task-priorities:
    get:
      tags: [TaskPriorities]
      summary: Danh sách mức ưu tiên
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách priorities
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TaskPriority' }
              example:
                - id: 1
                  name: "Cao"
                  level: 1
                  is_default: false

    post:
      tags: [TaskPriorities]
      summary: Tạo mức ưu tiên
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TaskPriority' }
            example:
              name: "Trung bình"
              level: 2
              is_default: true
      responses:
        '201':
          description: Tạo thành công

  /task-priorities/{id}:
    get:
      tags: [TaskPriorities]
      summary: Chi tiết mức ưu tiên
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin priority
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TaskPriority' }

    patch:
      tags: [TaskPriorities]
      summary: C���p nhật mức ưu tiên
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TaskPriority' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [TaskPriorities]
      summary: Xóa mức ưu tiên
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  # ========== TASK STATUSES ==========
  /task-statuses:
    get:
      tags: [TaskStatuses]
      summary: Danh sách trạng thái
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách statuses
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TaskStatus' }
              example:
                - id: 1
                  name: "Mới tạo"
                  code: "new"
                  is_closed_state: false

    post:
      tags: [TaskStatuses]
      summary: Tạo trạng thái
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TaskStatus' }
            example:
              name: "Đang xử lý"
              code: "processing"
              is_closed_state: false
      responses:
        '201':
          description: Tạo thành công

  /task-statuses/{id}:
    get:
      tags: [TaskStatuses]
      summary: Chi tiết trạng thái
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin status
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TaskStatus' }

    patch:
      tags: [TaskStatuses]
      summary: Cập nhật trạng thái
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TaskStatus' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [TaskStatuses]
      summary: Xóa trạng thái
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công
            # ========== TASKS ==========
  /tasks:
    get:
      tags: [Tasks]
      summary: Danh sách công việc
      description: Lấy danh sách task với filter, pagination, sort
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20 }
        - in: query
          name: status
          schema: { type: integer }
        - in: query
          name: department
          schema: { type: integer }
        - in: query
          name: assignee
          schema: { type: integer }
        - in: query
          name: priority
          schema: { type: integer }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: sort
          schema: { type: string, example: "-created_at,title" }
      responses:
        '200':
          description: Danh sách tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/Task' }
                  meta: { $ref: '#/components/schemas/MetaPaging' }
              example:
                data:
                  - id: 123
                    title: "Báo cáo tài chính Q1"
                    status_id: 2
                    priority_id: 1
                    deadline: "2026-03-10"
                    progress: 50
                meta:
                  page: 1
                  pageSize: 20
                  total: 89

    post:
      tags: [Tasks]
      summary: Tạo công việc mới
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Task' }
            example:
              title: "Báo cáo tài chính Q1"
              description: "Cần hoàn thành báo cáo tổng kết..."
              category_id: 2
              priority_id: 1
              status_id: 1
              department_id: 3
              assignees: [5, 8]
              start_date: "2026-02-10"
              due_date: "2026-03-10"
              confidential: false
              must_confirm: true
      responses:
        '201':
          description: Tạo thành công
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Task' }

  /tasks/{id}:
    get:
      tags: [Tasks]
      summary: Chi tiết công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin task
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Task' }

    patch:
      tags: [Tasks]
      summary: Cập nhật công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Task' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [Tasks]
      summary: Xóa công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  /tasks/import:
    post:
      tags: [Tasks]
      summary: Import tasks từ Excel
      security:
        - bearerAuth: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file: { type: string, format: binary }
      responses:
        '201':
          description: Import thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported: { type: integer, example: 25 }
                  failed: { type: integer, example: 2 }

  /tasks/{id}/assign:
    post:
      tags: [Tasks]
      summary: Gán người thực hiện
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                assignees:
                  type: array
                  items: { type: integer }
            example:
              assignees: [5, 8, 12]
      responses:
        '200':
          description: Gán thành công

  /tasks/{id}/subtask:
    post:
      tags: [Tasks]
      summary: Tạo subtask
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Task' }
            example:
              title: "Thu thập số liệu"
              parent_task_id: 123
      responses:
        '201':
          description: Tạo subtask thành công

  /tasks/{id}/status:
    patch:
      tags: [Tasks]
      summary: Đổi trạng thái công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                status_id: { type: integer }
                progress: { type: integer }
            example:
              status_id: 3
              progress: 80
      responses:
        '200':
          description: Đổi trạng thái thành công

  /tasks/{id}/files:
    get:
      tags: [Tasks]
      summary: Danh sách file đính kèm
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Danh sách files
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TaskFile' }

    post:
      tags: [Tasks]
      summary: Upload file
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file: { type: string, format: binary }
      responses:
        '201':
          description: Upload thành công
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TaskFile' }

  /tasks/{id}/files/{file_id}:
    delete:
      tags: [Tasks]
      summary: Xóa file
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
        - in: path
          name: file_id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  /tasks/{id}/logs:
    get:
      tags: [Tasks]
      summary: Lịch sử công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Danh sách logs
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TaskLog' }

  /tasks/{id}/comments:
    get:
      tags: [Tasks]
      summary: Danh sách comment
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Danh sách comments
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id: { type: integer }
                    user_id: { type: integer }
                    content: { type: string }
                    created_at: { type: string, format: date-time }

    post:
      tags: [Tasks]
      summary: Thêm comment
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                content: { type: string }
            example:
              content: "Đã hoàn thành phần thu thập số liệu"
      responses:
        '201':
          description: Thêm comment thành công

  # ========== TASK ASSIGNEES ==========
  /tasks/{id}/assignees:
    get:
      tags: [TaskAssignees]
      summary: Danh sách người được gán
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Danh sách assignees
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id: { type: integer }
                    user_id: { type: integer }
                    user_name: { type: string }
                    is_primary: { type: boolean }
                    assigned_at: { type: string, format: date-time }

    post:
      tags: [TaskAssignees]
      summary: Thêm người thực hiện
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id: { type: integer }
                is_primary: { type: boolean }
            example:
              user_id: 8
              is_primary: false
      responses:
        '201':
          description: Thêm thành công

  /tasks/{id}/assignees/{assign_id}:
    delete:
      tags: [TaskAssignees]
      summary: Gỡ người thực hiện
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
        - in: path
          name: assign_id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Gỡ thành công

    patch:
      tags: [TaskAssignees]
      summary: Cập nhật assignee
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
        - in: path
          name: assign_id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                is_primary: { type: boolean }
                active: { type: boolean }
      responses:
        '200':
          description: Cập nhật thành công
            # ========== WORKFLOWS ==========
  /workflows:
    get:
      tags: [Workflows]
      summary: Danh sách workflow
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách workflows
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Workflow' }

    post:
      tags: [Workflows]
      summary: Tạo workflow mới
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Workflow' }
            example:
              name: "Quy trình phê duyệt văn bản"
              description: "3 bước: Trưởng phòng → Phó giám đốc → Giám đốc"
              is_active: true
      responses:
        '201':
          description: Tạo thành công

  /workflows/{id}:
    get:
      tags: [Workflows]
      summary: Chi tiết workflow
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin workflow
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Workflow' }

    patch:
      tags: [Workflows]
      summary: Cập nhật workflow
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Workflow' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [Workflows]
      summary: Xóa workflow
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  /workflow-steps:
    get:
      tags: [Workflows]
      summary: Danh sách bước workflow
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: workflow_id
          schema: { type: integer }
      responses:
        '200':
          description: Danh sách steps
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/WorkflowStep' }

    post:
      tags: [Workflows]
      summary: Tạo bước workflow
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkflowStep' }
            example:
              workflow_id: 1
              name: "Trưởng phòng duyệt"
              order_index: 1
              is_approval: true
              auto_advance: false
              role_id: 3
      responses:
        '201':
          description: Tạo thành công

  /workflow-steps/{id}:
    patch:
      tags: [Workflows]
      summary: Cập nhật bước workflow
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkflowStep' }
      responses:
        '200':
          description: Cập nhật thành công

    delete:
      tags: [Workflows]
      summary: Xóa bước workflow
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Xóa thành công

  /tasks/{id}/approve:
    post:
      tags: [Workflows]
      summary: Phê duyệt công việc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                action: { type: string, enum: [approve, reject] }
                comments: { type: string }
            example:
              action: "approve"
              comments: "Đồng ý"
      responses:
        '200':
          description: Phê duyệt thành công

  /tasks/{id}/workflow-logs:
    get:
      tags: [Workflows]
      summary: Lịch sử workflow
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Timeline workflow
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    step_name: { type: string }
                    user_name: { type: string }
                    action: { type: string }
                    comments: { type: string }
                    created_at: { type: string, format: date-time }

  # ========== NOTIFICATIONS ==========
  /notifications:
    get:
      tags: [Notifications]
      summary: Danh sách thông báo
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: unread
          schema: { type: boolean }
      responses:
        '200':
          description: Danh sách notifications
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Notification' }

    post:
      tags: [Notifications]
      summary: Tạo/gửi thông báo
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Notification' }
            example:
              user_id: 5
              content: "Task #123 đã được gán cho bạn"
              type: "task"
              task_id: 123
      responses:
        '201':
          description: Gửi thành công

  /notifications/{id}/read:
    patch:
      tags: [Notifications]
      summary: Đánh dấu đã đọc
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Đánh dấu thành công

  /reminder:
    get:
      tags: [Notifications]
      summary: Danh sách nhắc việc
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách reminders
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id: { type: integer }
                    task_id: { type: integer }
                    remind_at: { type: string, format: date-time }

  /reminder/{id}/done:
    patch:
      tags: [Notifications]
      summary: Đánh dấu nhắc việc hoàn thành
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Đánh dấu thành công

  # ========== LOGS ==========
  /logs:
    get:
      tags: [Logs]
      summary: Nhật ký hệ thống
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: user
          schema: { type: integer }
        - in: query
          name: entity
          schema: { type: string }
        - in: query
          name: action
          schema: { type: string }
        - in: query
          name: from
          schema: { type: string, format: date }
        - in: query
          name: to
          schema: { type: string, format: date }
      responses:
        '200':
          description: Danh sách logs
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TaskLog' }

  /logs/{id}:
    get:
      tags: [Logs]
      summary: Chi tiết log entry
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Thông tin log
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TaskLog' }

  # ========== REPORTS ==========
  /reports/tasks-summary:
    get:
      tags: [Reports]
      summary: Tổng hợp công việc
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: group_by
          schema: { type: string, enum: [department, status, user] }
        - in: query
          name: from
          schema: { type: string, format: date }
        - in: query
          name: to
          schema: { type: string, format: date }
      responses:
        '200':
          description: Báo cáo tổng hợp
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        group: { type: string }
                        total: { type: integer }
                        completed: { type: integer }
                        in_progress: { type: integer }
                        overdue: { type: integer }

  /reports/progress-by-department:
    get:
      tags: [Reports]
      summary: Tiến độ theo phòng ban
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: from
          schema: { type: string, format: date }
        - in: query
          name: to
          schema: { type: string, format: date }
      responses:
        '200':
          description: Báo cáo tiến độ
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    department: { type: string }
                    total_tasks: { type: integer }
                    completion_rate: { type: number }

  /reports/chart-progress:
    get:
      tags: [Reports]
      summary: Dữ liệu biểu đồ
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: type
          schema: { type: string, enum: [pie, bar, line] }
        - in: query
          name: from
          schema: { type: string, format: date }
        - in: query
          name: to
          schema: { type: string, format: date }
      responses:
        '200':
          description: Dữ liệu chart
          content:
            application/json:
              schema:
                type: object
                properties:
                  labels: { type: array, items: { type: string } }
                  data: { type: array, items: { type: number } }

  /reports/export:
    get:
      tags: [Reports]
      summary: Xuất báo cáo
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: type
          schema: { type: string, enum: [excel, pdf] }
        - in: query
          name: report
          schema: { type: string }
      responses:
        '200':
          description: File báo cáo
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
